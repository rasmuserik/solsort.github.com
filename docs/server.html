<!DOCTYPE html>  <html> <head>   <title>server.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="err">#</span><span class="o">!</span><span class="err">/usr/bin/env node</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Development server and bundling tool for creating JavaScript web applications.</p>

<h2>Features:</h2>

<ul>
<li>CommonJS modules</li>
<li>watch files / recompile bundles on change </li>
<li>local server on port 8080</li>
<li>automatic, enforced checks with jshint</li>
<li>loading with line-numbers preserved on browsers supporting <code>//@sourceURL=</code></li>
<li>realtime generation of <code>docco</code>-documentation</li>
<li>different bundles, ie. one bundle for modern browsers with zepto.js and
another for legacy browsers with jquery, es5shim, json, etc.</li>
<li>bundles debug version + deploy version</li>
</ul>

<h2>Why make a new bundling tool</h2>

<p>None fitted exactly what I needed, and it was trivial to implement</p>

<ul>
<li>enderjs - misses watchin/development mode.</li>
<li>requirejs - requires manual wrapping of modules, and the dynamic loading
had issues on windows phones.</li>
<li>browserify - adding extra code, not minifying (may probably be done via
plugins, but that would probably be more work than to hack this code
together. Watching also didn't work well (vim writes file by moving the
new version into the old version, witch made watching barf).</li>
<li>assetgraph - looks promising, but solves another problem: full web sites,
where the need here is to have a developer friendly pure-javascript app
development.</li>
</ul>

<h2>TODO</h2>

<ul>
<li>npm-compatibility / better path handling + find depended modules
automatically</li>
<li>better error-reporting when uglify fails</li>
<li>code coverage</li>
<li>strip test code from modules (<code>exports.test*</code>) during minification</li>
<li>output widgets/apps too</li>
</ul>

<h1>The actual code</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Enforce strict checking when running checks.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*global require:true,console:true,process:true,__dirname:true*/</span>
<span class="cm">/*jshint es5:true,strict:true,trailing:true,curly:true,eqeqeq:true*/</span>
<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>Dependencies</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./util&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">async</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;async&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">uglify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;uglify-js&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">mustache</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mustache&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">jshint</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;jshint&#39;</span><span class="p">).</span><span class="nx">JSHINT</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">spawn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">spawn</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h1>Functions to build application bundle</h1>

<p>A lot of these are passing an <code>obj</code>-object around, which accumulates
the different information on the JavaScript file, ie. filename, source,
minified version, errors ...</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Read a file</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">readFile</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;readfile&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">filename</span><span class="p">);</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">filename</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">obj</span><span class="p">.</span><span class="nx">err</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
        <span class="nx">obj</span><span class="p">.</span><span class="nx">filedata</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Run strict jshint on the file</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">jsHint</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;jshint&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">filename</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">jshint</span><span class="p">(</span><span class="s1">&#39;/*jshint strict: true, trailing: true, curly: true, &#39;</span> <span class="o">+</span>
           <span class="s1">&#39;es5: true, eqeqeq: true*/(function(){&quot;use strict&quot;;&#39;</span> <span class="o">+</span>
           <span class="s1">&#39;/*global require:true,module:true,exports:true,&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;console:true,setTimeout:true */&#39;</span> <span class="o">+</span>
           <span class="nx">obj</span><span class="p">.</span><span class="nx">filedata</span> <span class="o">+</span> <span class="s1">&#39;})();&#39;</span><span class="p">);</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">jshint</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Reporting</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">jshint</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">obj</span><span class="p">.</span><span class="nx">jshint</span> <span class="o">+=</span> <span class="nx">mustache</span><span class="p">.</span><span class="nx">to_html</span><span class="p">(</span>
            <span class="s1">&#39;&lt;div&gt;{{file}} line {{line}} pos {{pos}}: {{err}}&lt;/div&gt;&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="nx">file</span><span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> 
            <span class="nx">pos</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">character</span><span class="p">,</span> <span class="nx">err</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">reason</span><span class="p">});</span>
    <span class="p">}</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>Minification and metaprocessing</h2>

<p>Currenly just minify.</p>

<p>TODO: add code coverage, and removal of test code</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">applyUglify</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;uglify&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">filename</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">uglify</span><span class="p">.</span><span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">filedata</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">mangled</span> <span class="o">=</span> <span class="nx">uglify</span><span class="p">.</span><span class="nx">uglify</span><span class="p">.</span><span class="nx">ast_mangle</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">squeezed</span> <span class="o">=</span> <span class="nx">uglify</span><span class="p">.</span><span class="nx">uglify</span><span class="p">.</span><span class="nx">ast_squeeze</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
        <span class="nx">obj</span><span class="p">.</span><span class="nx">minified</span> <span class="o">=</span> <span class="nx">uglify</span><span class="p">.</span><span class="nx">uglify</span><span class="p">.</span><span class="nx">gen_code</span><span class="p">(</span><span class="nx">squeezed</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>TODO: nicer error-reporting</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">obj</span><span class="p">.</span><span class="nx">err</span> <span class="o">=</span> <span class="p">{</span><span class="nx">err</span><span class="o">:</span> <span class="s1">&#39;uglify-error&#39;</span><span class="p">,</span> <span class="nx">details</span><span class="o">:</span> <span class="nx">e</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Code used to define the module in the bundle.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">moduleString</span><span class="p">(</span><span class="nx">modulename</span><span class="p">,</span> <span class="nx">modulesource</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;bundler.module(\&#39;&#39;</span><span class="p">,</span> <span class="nx">modulename</span><span class="p">,</span> <span class="s1">&#39;\&#39;,\&#39;&#39;</span><span class="p">,</span> 
            <span class="nx">util</span><span class="p">.</span><span class="nx">stringEscape</span><span class="p">(</span><span class="nx">modulesource</span><span class="p">)</span> <span class="p">,</span> <span class="s1">&#39;\&#39;);&#39;</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Do, what has to be done, to a single file. This is where the core logic of
processing each file is defined.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">processFile</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;docco&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">filename</span><span class="p">]);</span>
    <span class="nx">readFile</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">jsHint</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">applyUglify</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
    <span class="p">});});});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h3>Utilities for watching a files for changes</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">watchCallback</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">writeModulesCallback</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">unwatchFile</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">filename</span><span class="p">);</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">watchFile</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">watchCallback</span><span class="p">);</span>
    <span class="nx">processFile</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">writeModulesCallback</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};}</span>

<span class="kd">function</span> <span class="nx">watchObj</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">writeModulesCallback</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>needs timeout to handle vims delete+create file when saving</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">obj</span><span class="p">.</span><span class="nx">watchCallback</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">delaySingleExecAsync</span><span class="p">(</span>
            <span class="nx">watchCallback</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">writeModulesCallback</span><span class="p">),</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">watchFile</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">watchCallback</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">writeBundle</span><span class="p">(</span><span class="nx">bundle</span><span class="p">,</span> <span class="nx">fileObjHash</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;writebundle&#39;</span><span class="p">,</span> <span class="nx">bundle</span><span class="p">.</span><span class="nx">out</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">resultFile</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nx">bundle</span><span class="p">.</span><span class="nx">libs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">libName</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">lib</span> <span class="o">=</span> <span class="nx">fileObjHash</span><span class="p">[</span><span class="nx">libName</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">libName</span><span class="p">,</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">err</span><span class="p">);</span>
            <span class="nx">err</span> <span class="o">+=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">err</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">resultFile</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">filedata</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">bundle</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="nx">fileObjHash</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">err</span> <span class="o">+=</span> <span class="nx">moduleName</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">err</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">module</span><span class="p">.</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">resultFile</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">moduleString</span><span class="p">(</span>
                <span class="nx">moduleName</span><span class="p">,</span> <span class="nx">module</span><span class="p">[</span><span class="nx">bundle</span><span class="p">.</span><span class="nx">moduleVersion</span><span class="p">]));</span>
            <span class="nx">err</span> <span class="o">+=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">jshint</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">resultFile</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">bundle</span><span class="p">.</span><span class="nx">run</span><span class="p">);</span>
    <span class="nx">resultFile</span> <span class="o">=</span> <span class="nx">resultFile</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">resultFile</span> <span class="o">=</span> <span class="s2">&quot;document.body.innerHTML=&#39;&quot;</span> <span class="o">+</span>
            <span class="nx">util</span><span class="p">.</span><span class="nx">stringEscape</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="o">+</span> <span class="s2">&quot;&#39;;&quot;</span><span class="p">;</span>
    <span class="p">}</span> 
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">bundle</span><span class="p">.</span><span class="nx">out</span><span class="p">,</span> <span class="nx">resultFile</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">writeBundles</span><span class="p">(</span><span class="nx">bundles</span><span class="p">,</span> <span class="nx">fileObjs</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fileObjHash</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">fileObjs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fileObjHash</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">filename</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">async</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">bundles</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bundle</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">writeBundle</span><span class="p">(</span><span class="nx">bundle</span><span class="p">,</span> <span class="nx">fileObjHash</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>

    <span class="nx">writeCacheManifest</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">writeCacheManifest</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span><span class="nx">j</span><span class="p">,</span><span class="nx">k</span><span class="p">,</span><span class="nx">l</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">manifest</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CACHE MANIFEST&#39;</span><span class="p">,</span> <span class="s1">&#39;# &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()),</span> <span class="s1">&#39;\nNETWORK:\n*&#39;</span><span class="p">,</span> <span class="s1">&#39;\nCACHE:&#39;</span><span class="p">,</span> <span class="s1">&#39;/dist/bundle.min.js&#39;</span><span class="p">];</span>
    <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="o">++</span><span class="nx">i</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">j</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="o">++</span><span class="nx">j</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="nx">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">k</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="o">++</span><span class="nx">k</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="nx">l</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">l</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="o">++</span><span class="nx">l</span><span class="p">){</span>
        <span class="nx">manifest</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;/dist/combigame&#39;</span><span class="o">+</span><span class="nx">i</span><span class="o">+</span><span class="nx">j</span><span class="o">+</span><span class="nx">k</span><span class="o">+</span><span class="nx">l</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">);</span>
    <span class="p">}}}}</span>
    <span class="nx">async</span><span class="p">.</span><span class="nx">forEach</span><span class="p">([</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;notes&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">manifest</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="nx">done</span><span class="p">()</span>
        <span class="p">});</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;writing manifest.appcache&#39;</span><span class="p">);</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="s1">&#39;manifest.appcache&#39;</span><span class="p">,</span> <span class="nx">manifest</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">bundle</span><span class="p">(</span><span class="nx">bundles</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">moduleObjs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">bundles</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;modules&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">flatten</span><span class="p">().</span><span class="nx">uniq</span><span class="p">().</span><span class="nx">value</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span><span class="nx">filename</span><span class="o">:</span> <span class="nx">filename</span><span class="p">};</span> 
        <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">libObjs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">bundles</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;libs&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">flatten</span><span class="p">().</span><span class="nx">uniq</span><span class="p">().</span><span class="nx">value</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span><span class="nx">filename</span><span class="o">:</span> <span class="nx">filename</span><span class="p">};</span> 
        <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">fileObjs</span> <span class="o">=</span> <span class="nx">libObjs</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">moduleObjs</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">delayedWriteBundles</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">delaySingleExecAsync</span><span class="p">(</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">writeBundles</span><span class="p">(</span><span class="nx">bundles</span><span class="p">,</span> <span class="nx">fileObjs</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">async</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">libObjs</span><span class="p">,</span> <span class="nx">readFile</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">objs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">async</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">moduleObjs</span><span class="p">,</span> <span class="nx">processFile</span><span class="p">,</span> <span class="nx">delayedWriteBundles</span><span class="p">);});</span>

    <span class="nx">moduleObjs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">watchObj</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">delayedWriteBundles</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h2>Generate documentation for itself</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">docself</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="s1">&#39;scripts/server.js&#39;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">unwatchFile</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
    <span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;docco&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">self</span><span class="p">]);</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">watchFile</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">docself</span><span class="p">);</span> <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>

<span class="p">}</span>
<span class="nx">docself</span><span class="p">();</span>
<span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;jshint&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;scripts/server.js&#39;</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h1>The actual bundles</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">base</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;depend/zepto.min.js&quot;</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">oldAndroid</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;depend/es5-shim.min.js&quot;</span><span class="p">,</span><span class="s2">&quot;depend/zepto.min.js&quot;</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">legacy</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;depend/es5-shim.min.js&quot;</span><span class="p">,</span>
              <span class="s2">&quot;depend/jquery-1.7.1.min.js&quot;</span><span class="p">,</span>
              <span class="s2">&quot;depend/json2.min.js&quot;</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">libs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;depend/modernizr.js&quot;</span><span class="p">,</span>
            <span class="s2">&quot;depend/underscore-min.js&quot;</span><span class="p">,</span>
            <span class="s2">&quot;depend/showdown.min.js&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scripts/bundler.js&quot;</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span>  <span class="p">[</span><span class="s2">&quot;scripts/util.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/jsxml.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/main.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/showSource.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/menu.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/combigame.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/timelog.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/notescore.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/dkcities.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/julia4d.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/rasmuserik.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/rain.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/graph.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/sierp.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/brown.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/plasma.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/bidiv.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/webutil.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scripts/fullbrows.js&quot;</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">bundles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span> <span class="nx">out</span><span class="o">:</span> <span class="s1">&#39;apps/combigame/combigame.js&#39;</span><span class="p">,</span>
      <span class="nx">libs</span><span class="o">:</span> <span class="nx">oldAndroid</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">libs</span><span class="p">),</span>
      <span class="nx">modules</span><span class="o">:</span> <span class="nx">modules</span><span class="p">,</span>
      <span class="nx">moduleVersion</span><span class="o">:</span> <span class="s1">&#39;minified&#39;</span><span class="p">,</span>
      <span class="nx">run</span><span class="o">:</span> <span class="s1">&#39;bundler.require(&quot;combigame&quot;).run();&#39;</span><span class="p">},</span>

    <span class="p">{</span> <span class="nx">out</span><span class="o">:</span> <span class="s1">&#39;dist/bundle.debug.js&#39;</span><span class="p">,</span>
      <span class="nx">libs</span><span class="o">:</span> <span class="nx">base</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">libs</span><span class="p">),</span>
      <span class="nx">modules</span><span class="o">:</span> <span class="nx">modules</span><span class="p">,</span>
      <span class="nx">moduleVersion</span><span class="o">:</span> <span class="s1">&#39;filedata&#39;</span><span class="p">,</span>
      <span class="nx">run</span><span class="o">:</span> <span class="s1">&#39;bundler.require(&quot;main&quot;).main()&#39;</span><span class="p">},</span>

    <span class="p">{</span> <span class="nx">out</span><span class="o">:</span> <span class="s1">&#39;dist/bundle.legacy.debug.js&#39;</span><span class="p">,</span>
      <span class="nx">libs</span><span class="o">:</span> <span class="nx">legacy</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">libs</span><span class="p">),</span>
      <span class="nx">modules</span><span class="o">:</span> <span class="nx">modules</span><span class="p">,</span>
      <span class="nx">moduleVersion</span><span class="o">:</span> <span class="s1">&#39;filedata&#39;</span><span class="p">,</span>
      <span class="nx">run</span><span class="o">:</span> <span class="s1">&#39;bundler.require(&quot;main&quot;).main()&#39;</span><span class="p">},</span>

    <span class="p">{</span> <span class="nx">out</span><span class="o">:</span> <span class="s1">&#39;dist/bundle.min.js&#39;</span><span class="p">,</span>
      <span class="nx">libs</span><span class="o">:</span> <span class="nx">base</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">libs</span><span class="p">),</span>
      <span class="nx">modules</span><span class="o">:</span> <span class="nx">modules</span><span class="p">,</span>
      <span class="nx">moduleVersion</span><span class="o">:</span> <span class="s1">&#39;minified&#39;</span><span class="p">,</span>
      <span class="nx">run</span><span class="o">:</span> <span class="s1">&#39;bundler.require(&quot;main&quot;).main()&#39;</span><span class="p">},</span>

    <span class="p">{</span> <span class="nx">out</span><span class="o">:</span> <span class="s1">&#39;dist/bundle.legacy.min.js&#39;</span><span class="p">,</span>
      <span class="nx">libs</span><span class="o">:</span> <span class="nx">legacy</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">libs</span><span class="p">),</span>
      <span class="nx">modules</span><span class="o">:</span> <span class="nx">modules</span><span class="p">,</span>
      <span class="nx">moduleVersion</span><span class="o">:</span> <span class="s1">&#39;minified&#39;</span><span class="p">,</span>
      <span class="nx">run</span><span class="o">:</span> <span class="s1">&#39;bundler.require(&quot;main&quot;).main()&#39;</span><span class="p">}</span>
<span class="p">];</span>

<span class="nx">bundle</span><span class="p">(</span><span class="nx">bundles</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h1>Web server</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Start a simple local web server </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">).</span><span class="kr">static</span><span class="p">(</span>
            <span class="nx">__dirname</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/scripts$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)));</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">8080</span><span class="p">;</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\nstarting server on port &#39;</span> <span class="o">+</span> <span class="nx">port</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>

<span class="p">})();</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 