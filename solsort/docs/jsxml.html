<!DOCTYPE html>  <html> <head>   <title>jsxml.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               jsxml.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>JsonML</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Various functions for handling
jsonml in array form.
For more info on jsonml,
see <a href="http://jsonml.org/">jsonml.org</a>
or <a href="http://en.wikipedia.org/wiki/JsonML">wikipedia</a></p>

<p>Implemented to be as portable as possible.
Not depending on any libraries, and also
avoid regular expressions to be possible to
run on javascript-subsets on j2me devices.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*global document */</span>
<span class="cm">/*jshint evil:true */</span>
<span class="kd">var</span> <span class="nx">global</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Utility</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Error handler</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">jsonmlError</span><span class="p">(</span><span class="nx">desc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nx">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">plainObject</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>XML escaped entity table</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">entities</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;quot&quot;</span><span class="o">:</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;amp&quot;</span><span class="o">:</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;apos&quot;</span><span class="o">:</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lt&quot;</span><span class="o">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;gt&quot;</span><span class="o">:</span> <span class="s1">&#39;&gt;&#39;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Generate a reverse xml entity table.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">reventities</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">entities</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="nx">entities</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">entities</span><span class="p">[</span><span class="nx">key</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
    <span class="p">}</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>XML parser</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Parse an XML-string.
Actually this is not a full implementation, but just
the basic parts to get it up running.
Nonetheless it is Good Enough(tm) for most uses.</p>

<p>Known deficiencies: CDATA is not supported, will accept even
non-well-formed documents, <?... > <!... > are not really handled, ...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">fromXml</span><span class="p">(</span><span class="nx">xml</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">xml</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">jsonmlError</span><span class="p">(</span>
            <span class="s2">&quot;Error: jsonml.parseXML didn&#39;t receive a string as parameter&quot;</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>white space definition</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">whitespace</span> <span class="o">=</span> <span class="s2">&quot; \n\r\t&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>the current char in the string that is being parsed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">xml</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>the position in the string</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>stack for handling nested tags</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>current tag being parsed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>read the next char from the string</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">next_char</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">++</span><span class="nx">pos</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">xml</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">c</span> <span class="o">=</span> <span class="nx">xml</span><span class="p">[</span><span class="nx">pos</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">c</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
       <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>check if the current char is one of those in the string parameter</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">is_a</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>return the string from the current position to right before the first
occurence of any of symb. Translate escaped xml entities to their value
on the fly.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">read_until</span><span class="p">(</span><span class="nx">symb</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">while</span><span class="p">(</span><span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">is_a</span><span class="p">(</span><span class="nx">symb</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">next_char</span><span class="p">();</span>
                <span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">read_until</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">entity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">entity</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">c</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">16</span><span class="p">));</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">c</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">c</span> <span class="o">=</span> <span class="nx">entities</span><span class="p">[</span><span class="nx">entity</span><span class="p">];</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">jsonmlError</span><span class="p">(</span><span class="s2">&quot;error: unrecognisable xml entity: &quot;</span> <span class="o">+</span>
                                <span class="nx">entity</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
            <span class="nx">next_char</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The actual parsing</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span><span class="p">(</span><span class="nx">is_a</span><span class="p">(</span><span class="nx">whitespace</span><span class="p">))</span> <span class="p">{</span> <span class="nx">next_char</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">is_a</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">next_char</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p><code>&lt;?xml ... &gt;</code>, <code>&lt;!-- --&gt;</code> or similar - skip these</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span><span class="p">(</span><span class="nx">is_a</span><span class="p">(</span><span class="s2">&quot;?!&quot;</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">xml</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;!--&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">pos</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
                    <span class="k">while</span><span class="p">(</span><span class="nx">xml</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="o">++</span><span class="nx">pos</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">read_until</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">);</span>
                <span class="nx">next_char</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><code>&lt;sometag ...&gt;</code> - handle begin tag</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_a</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>read tag name</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">newtag</span> <span class="o">=</span> <span class="p">[</span><span class="nx">read_until</span><span class="p">(</span><span class="nx">whitespace</span><span class="o">+</span><span class="s2">&quot;&gt;/&quot;</span><span class="p">)];</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>read attributes</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="kd">var</span> <span class="nx">has_attributes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">while</span><span class="p">(</span><span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">is_a</span><span class="p">(</span><span class="nx">whitespace</span><span class="p">))</span> <span class="p">{</span> <span class="nx">next_char</span><span class="p">();</span> <span class="p">}</span>
                <span class="k">while</span><span class="p">(</span><span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">is_a</span><span class="p">(</span><span class="s2">&quot;&gt;/&quot;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">has_attributes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="kd">var</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">read_until</span><span class="p">(</span><span class="nx">whitespace</span> <span class="o">+</span> <span class="s2">&quot;=&gt;&quot;</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">next_char</span><span class="p">();</span>
                        <span class="kd">var</span> <span class="nx">value_terminator</span> <span class="o">=</span> <span class="nx">whitespace</span><span class="o">+</span><span class="s2">&quot;&gt;/&quot;</span><span class="p">;</span>
                        <span class="k">if</span><span class="p">(</span><span class="nx">is_a</span><span class="p">(</span><span class="s1">&#39;&quot;\&#39;&#39;</span><span class="p">))</span> <span class="p">{</span> <span class="nx">value_terminator</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span> <span class="nx">next_char</span><span class="p">();</span> <span class="p">}</span>
                        <span class="nx">attributes</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">read_until</span><span class="p">(</span><span class="nx">value_terminator</span><span class="p">);</span>
                        <span class="k">if</span><span class="p">(</span><span class="nx">is_a</span><span class="p">(</span><span class="s1">&#39;&quot;\&#39;&#39;</span><span class="p">))</span> <span class="p">{</span> <span class="nx">next_char</span><span class="p">();</span> <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">jsonmlError</span><span class="p">(</span><span class="s2">&quot;something not attribute in tag&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">while</span><span class="p">(</span><span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">is_a</span><span class="p">(</span><span class="nx">whitespace</span><span class="p">))</span> <span class="p">{</span> <span class="nx">next_char</span><span class="p">();</span> <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">has_attributes</span><span class="p">)</span> <span class="p">{</span> <span class="nx">newtag</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">attributes</span><span class="p">);</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>end of tag, is it <code>&lt;.../&gt;</code> or  <code>&lt;...&gt;</code></p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span><span class="p">(</span><span class="nx">is_a</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">next_char</span><span class="p">();</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_a</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">jsonmlError</span><span class="p">(</span><span class="s1">&#39;expected &quot;&gt;&quot; after &quot;/&quot; within tag&#39;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nx">tag</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newtag</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tag</span><span class="p">);</span>
                    <span class="nx">tag</span> <span class="o">=</span> <span class="nx">newtag</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">next_char</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><code>&lt;/something&gt;</code> - handle end tag</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">next_char</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">read_until</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                    <span class="nx">jsonmlError</span><span class="p">(</span><span class="s2">&quot;end tag not matching: &quot;</span> <span class="o">+</span> <span class="nx">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="nx">next_char</span><span class="p">();</span>
                <span class="kd">var</span> <span class="nx">parent_tag</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
                        <span class="k">typeof</span><span class="p">(</span><span class="nx">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">tag</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">parent_tag</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tag</span><span class="p">);</span>
                <span class="nx">tag</span> <span class="o">=</span> <span class="nx">parent_tag</span><span class="p">;</span>

            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>actual content / data between tags</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">tag</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">read_until</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">tag</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>The exported xml parser</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">fromXml</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xml</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>find the actual root element, ie. " <foo /> " will be parsed to [" ", ["foo"], " "],
so skip the parsed until we find an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">fromXml</span><span class="p">(</span><span class="nx">xml</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">parsed</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">parsed</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h2>XML generation</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Append the characters of <code>str</code>, or the xml-entity they map to, to the <code>acc</code>umulator array.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">xmlEscape</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">acc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">str</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">reventities</span><span class="p">[</span><span class="nx">c</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="nx">s</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="cm">/*code &lt; 32 ||*/</span> <span class="nx">code</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&amp;#&quot;</span> <span class="o">+</span> <span class="nx">code</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>The actual implementation. As the XML-string is built by appending to the
<code>acc</code>umulator.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">toXmlAcc</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">,</span> <span class="nx">acc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">);</span>
        <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">jsonml</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="k">typeof</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
                <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
                <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;=&quot;&#39;</span><span class="p">);</span>
                <span class="nx">xmlEscape</span><span class="p">(</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">acc</span><span class="p">);</span>
                <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
            <span class="p">}</span> <span class="p">}</span>
            <span class="o">++</span><span class="nx">pos</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">jsonml</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">);</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="nx">toXmlAcc</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">[</span><span class="nx">pos</span><span class="p">],</span> <span class="nx">acc</span><span class="p">);</span>
                <span class="o">++</span><span class="nx">pos</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">jsonml</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
            <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;/&quot;</span><span class="p">);</span>
            <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot; /&gt;&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">xmlEscape</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">),</span> <span class="nx">acc</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Convert jsonml in array form to xml.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">toXml</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">acc</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">toXmlAcc</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">,</span> <span class="nx">acc</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">acc</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h2>Utility functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Apply a function to all the child elements of a given jsonml array.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">childReduce</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">childReduce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">acc</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">jsonml</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">first</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;object&quot;</span> <span class="o">||</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">first</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">acc</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">first</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">jsonml</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">acc</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">jsonml</span><span class="p">[</span><span class="nx">pos</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">acc</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">getAttr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">jsonml</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nx">attribute</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Add a property to the object. If the property is already there, append
the <code>val</code>ue to an array at the key instead, possibly putting existing
object in front of such array, if that is not an array yet.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">addprop</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">val</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Internal function called by toObject. Return an object corresponding to
the child nodes of the <code>jsonml</code>-parameter</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">toObjectInner</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">jsonml</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">pos</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">attr</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">attr</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">result</span><span class="p">[</span><span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attr</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="p">}</span> <span class="p">}</span>
        <span class="nx">pos</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">pos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">attr</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">attr</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">jsonml</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">jsonml</span><span class="p">[</span><span class="nx">pos</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">current</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">addprop</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">current</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">toObjectInner</span><span class="p">(</span><span class="nx">current</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">addprop</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="nx">current</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="o">++</span><span class="nx">pos</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Convert jsonml into an easier subscriptable json structure, not preserving
the order of the elements</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">toObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">result</span><span class="p">[</span><span class="nx">jsonml</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">toObjectInner</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>


<span class="kd">function</span> <span class="nx">visit</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">jsonml</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">elem</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">visit</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">insertEmptyAttributes</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">plainObject</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">jsonml</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">jsonml</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">withAttr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">visit</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">insertEmptyAttributes</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">toDOM</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">toDOM</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">elem</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">insertEmptyAttributes</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">);</span>
        <span class="nx">elem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="kd">var</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">jsonml</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">jsonml</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">elem</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">toDOM</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
        <span class="p">}</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">attr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">attr</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">attr</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="nx">elem</span><span class="p">[{</span>
                        <span class="s1">&#39;class&#39;</span><span class="o">:</span> <span class="s1">&#39;className&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;for&#39;</span><span class="o">:</span> <span class="s1">&#39;htmlFor&#39;</span>
                    <span class="p">}[</span><span class="nx">name</span><span class="p">]</span> <span class="o">||</span> <span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attr</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
                <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>some properties cannot be set on internet explorer</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="p">}</span>
                <span class="nx">elem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">attr</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>

                <span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">$</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;on&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">attr</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="o">?</span>
                            <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="nx">attr</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="o">:</span>
                            <span class="nx">attr</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
                    <span class="nx">global</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">elem</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">fn</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">jsonml</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">elem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">jsonml</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">elem</span><span class="p">;</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 