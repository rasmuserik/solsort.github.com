<!DOCTYPE html>  <html> <head>   <title>timelog.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               timelog.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*global window: true*/</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>var window = require('window');</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">$</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;zquery&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">webutil</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webutil&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fullbrows</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fullbrows&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">timelog</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">recentLength</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>


<span class="kd">function</span> <span class="nx">callbackFn</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">setCurrent</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Render timelog ui</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">drawTaskButtons</span><span class="p">(</span><span class="nx">$target</span><span class="p">,</span> <span class="nx">x0</span><span class="p">,</span> <span class="nx">y0</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">spacing</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="nx">h</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">tasks</span> <span class="o">=</span> <span class="nx">getTaskList</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">getCurrent</span><span class="p">();</span>
    <span class="nx">spacing</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$button</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div&gt;&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">tasks</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">pad</span> <span class="o">=</span> <span class="nx">spacing</span> <span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">$button</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">css</span><span class="p">({</span>
                <span class="nx">margin</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="nx">width</span><span class="o">:</span> <span class="nx">w</span><span class="p">,</span>
                <span class="nx">height</span><span class="o">:</span> <span class="nx">h</span><span class="p">,</span>
                <span class="nx">position</span><span class="o">:</span> <span class="s1">&#39;absolute&#39;</span><span class="p">,</span>
                <span class="nx">borderRadius</span><span class="o">:</span> <span class="nx">spacing</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">,</span>
                <span class="nx">backgroundColor</span><span class="o">:</span> <span class="nx">util</span><span class="p">.</span><span class="nx">colorHash</span><span class="p">(</span><span class="nx">text</span><span class="p">),</span>
                <span class="nx">padding</span><span class="o">:</span><span class="mi">0</span><span class="p">});</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">$button</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

        <span class="nx">$target</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">$button</span><span class="p">);</span>
        <span class="nx">webutil</span><span class="p">.</span><span class="nx">scaleText</span><span class="p">(</span><span class="nx">$button</span><span class="p">);</span>
        <span class="nx">$button</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span><span class="nx">display</span><span class="o">:</span> <span class="s1">&#39;inline-block&#39;</span><span class="p">,</span>
                <span class="nx">verticalAlign</span><span class="o">:</span> <span class="s1">&#39;middle&#39;</span><span class="p">,</span>
                <span class="nx">padding</span><span class="o">:</span> <span class="nx">pad</span><span class="p">,</span>
                <span class="nx">margin</span><span class="o">:</span> <span class="p">(</span><span class="nx">spacing</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">),</span>
                <span class="nx">width</span><span class="o">:</span> <span class="nx">w</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">,</span>
                <span class="nx">position</span><span class="o">:</span> <span class="s1">&#39;relative&#39;</span><span class="p">});</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">text</span> <span class="o">===</span> <span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$button</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;boxShadow&#39;</span><span class="p">,</span> <span class="s1">&#39;inset 3px 3px 9px rgba(0, 0, 0, .8)&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">$button</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;boxShadow&#39;</span><span class="p">,</span> <span class="s1">&#39;3px 3px 9px rgba(0, 0, 0, .8)&#39;</span><span class="p">);</span>
            <span class="nx">$button</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;touchstart mousedown click&#39;</span><span class="p">,</span> <span class="nx">callbackFn</span><span class="p">(</span><span class="nx">text</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/*</span>
<span class="cm">    var buttonWidth = (w-spacing*5)/4|0;</span>
<span class="cm">    var buttonHeight = (h-spacing*6)/5|0;</span>
<span class="cm">    var pad = Math.min(buttonHeight,buttonWidth) &gt;&gt; 3;</span>
<span class="cm">    for(var x = 0; x &lt; 4; ++x) {</span>
<span class="cm">        for(var y = 0; y &lt; 5; ++y) {</span>
<span class="cm">            var $button = $(&#39;&lt;div&gt;&#39;);</span>
<span class="cm">            var text = tasks[x+y*4];</span>
<span class="cm">            var left =  x0 + x * (buttonWidth + spacing)+spacing;</span>
<span class="cm">            var top = y0 + y * (buttonHeight + spacing)+spacing;</span>
<span class="cm">            $button.text(text)</span>
<span class="cm">            .css({</span>
<span class="cm">                top: top,</span>
<span class="cm">                left: left,</span>
<span class="cm">                borderRadius: spacing&gt;&gt;1,</span>
<span class="cm">                backgroundColor: util.colorHash(text)</span>
<span class="cm">                })</span>
<span class="cm">            .width(buttonWidth - 2*pad)</span>
<span class="cm">            .height(buttonHeight - 2*pad);</span>

<span class="cm">            $target.append($button);</span>
<span class="cm">            webutil.scaleText($button);</span>
<span class="cm">            $button.css({</span>
<span class="cm">                &#39;position&#39;: &#39;absolute&#39;,</span>
<span class="cm">                padding: pad</span>
<span class="cm">                });</span>
<span class="cm">            console.log(text, current);</span>
<span class="cm">            if(text === current) {</span>
<span class="cm">                $button.css(&#39;boxShadow&#39;, &#39;inset 3px 3px 9px rgba(0, 0, 0, .8)&#39;);</span>
<span class="cm">            } else {</span>
<span class="cm">                $button.css(&#39;boxShadow&#39;, &#39;3px 3px 9px rgba(0, 0, 0, .8)&#39;);</span>
<span class="cm">                $button.bind(&#39;touchstart mousedown click&#39;, callbackFn(text));</span>
<span class="cm">            }</span>
<span class="cm">        }</span>
<span class="cm">    }</span>

<span class="cm">    for(var i = 0; i &lt; tasks.length; ++i) {</span>
<span class="cm">    }</span>
<span class="cm">    */</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">renderUI</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">$content</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#content&#39;</span><span class="p">);</span>
    <span class="nx">$content</span>
        <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">css</span><span class="p">({</span>
            <span class="nx">textAlign</span><span class="o">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="nx">backgroundColor</span><span class="o">:</span> <span class="s1">&#39;white&#39;</span>
            <span class="p">});</span>
    <span class="nx">drawTaskButtons</span><span class="p">(</span><span class="nx">$content</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span><span class="o">/</span><span class="mi">40</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">usageObj</span><span class="o">=</span> <span class="nx">usage</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">report</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">usageObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">report</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">usageObj</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="nx">report</span> <span class="o">=</span> <span class="nx">report</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;pre&gt;&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">report</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">)));</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>Utility functions for accessing the timelog data structure</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/** Set current task */</span>
<span class="kd">function</span> <span class="nx">setCurrent</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">||</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;setCurrent&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">name</span><span class="p">};</span>
    <span class="nx">timelog</span><span class="p">.</span><span class="nx">changes</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">;</span>
    <span class="nx">addEntry</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
    <span class="nx">sync</span><span class="p">();</span>
    <span class="nx">renderUI</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/** Get the list of n most recent tasks, ordered by latest appearance */</span>
<span class="kd">function</span> <span class="nx">getTaskList</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">entries</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">timelog</span><span class="p">.</span><span class="nx">tasks</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">values</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">latest</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">latest</span><span class="p">;</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">entries</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">earliest</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">earliest</span><span class="p">;</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">(</span><span class="nx">entries</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Get name of current task */</span>
<span class="kd">function</span> <span class="nx">getCurrent</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">timelog</span><span class="p">.</span><span class="nx">recentLog</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">timelog</span><span class="p">.</span><span class="nx">recentLog</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">+</span><span class="nx">e</span><span class="p">;</span> <span class="p">}))].</span><span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;undefined&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cm">/** Get time usage */</span>
<span class="kd">function</span> <span class="nx">usage</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">times</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">timelog</span><span class="p">.</span><span class="nx">recentLog</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">+</span><span class="nx">e</span><span class="p">;</span> <span class="p">}).</span><span class="nx">sort</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">days</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">timelog</span><span class="p">.</span><span class="nx">recentLog</span><span class="p">[</span><span class="nx">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
    <span class="nx">times</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">day</span> <span class="o">=</span> <span class="p">((</span><span class="o">+</span><span class="nx">time</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
            <span class="nx">day</span> <span class="o">=</span> <span class="nx">days</span><span class="p">[</span><span class="nx">day</span><span class="p">]</span> <span class="o">=</span> <span class="nx">days</span><span class="p">[</span><span class="nx">day</span><span class="p">]</span> <span class="o">||</span> <span class="p">{};</span>
            <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">timelog</span><span class="p">.</span><span class="nx">recentLog</span><span class="p">[</span><span class="nx">time</span><span class="p">];</span>
            <span class="nx">day</span><span class="p">[</span><span class="nx">prev</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">day</span><span class="p">[</span><span class="nx">prev</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">id</span> <span class="o">-</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
            <span class="nx">prev</span> <span class="o">=</span> <span class="nx">current</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">days</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Localstorage</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/** Write timelog to localstorage */</span>
<span class="kd">function</span> <span class="nx">save</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">recentLog</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">timelog</span><span class="p">.</span><span class="nx">recentLog</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">+</span><span class="nx">key</span> <span class="o">&gt;</span> <span class="nx">now</span><span class="o">-</span><span class="nx">recentLength</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">recentLog</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">timelog</span><span class="p">.</span><span class="nx">recentLog</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">});</span>
    <span class="nx">timelog</span><span class="p">.</span><span class="nx">recentLog</span> <span class="o">=</span> <span class="nx">recentLog</span><span class="p">;</span>

    <span class="nx">storage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;timelog&#39;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">timelog</span><span class="p">));</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">timelog</span> <span class="o">=</span> <span class="nx">timelog</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Load timelog from localstorage */</span>
<span class="kd">function</span> <span class="nx">load</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">timelog</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">storage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;timelog&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;false&#39;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;timelog:&#39;</span><span class="p">,</span> <span class="nx">timelog</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">timelog</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">accountName</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">prompt</span><span class="p">(</span><span class="s1">&#39;Please enter a name/passphrase for your timelog timelog.account. This should be a globally uniq secret name only you should know. Anybody knowing the name can acces the timelog timelog.account. If the name does not exist already, a new timelog will be created&#39;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">accountName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">timelog</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">account</span><span class="o">:</span> <span class="nx">accountName</span><span class="p">,</span>
            <span class="nx">lastTime</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">recentLog</span><span class="o">:</span> <span class="p">{},</span>
            <span class="nx">tasks</span><span class="o">:</span> <span class="p">{},</span>
            <span class="nx">changes</span><span class="o">:</span> <span class="p">{}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Synchronisation with central server</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Add an entry to the timelog, - this is both used for synchronisation, and</span>
<span class="cm"> * also when creating a new event.</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">addEntry</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">timelog</span><span class="p">.</span><span class="nx">recentLog</span><span class="p">[</span><span class="nx">elem</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">task</span> <span class="o">=</span> <span class="nx">timelog</span><span class="p">.</span><span class="nx">tasks</span><span class="p">[</span><span class="nx">elem</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span> <span class="o">||</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">earliest</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">latest</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
    <span class="nx">task</span><span class="p">.</span><span class="nx">latest</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">task</span><span class="p">.</span><span class="nx">latest</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">timelog</span><span class="p">.</span><span class="nx">tasks</span><span class="p">[</span><span class="nx">elem</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="nx">task</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Callback function, for answers from server */</span>
<span class="kd">function</span> <span class="nx">syncCallback</span><span class="p">(</span><span class="nx">eventArr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">eventArr</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">timelog</span><span class="p">.</span><span class="nx">changes</span><span class="p">[</span><span class="nx">eventArr</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">eventArr</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">timelog</span><span class="p">.</span><span class="nx">lastTime</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">timelog</span><span class="p">.</span><span class="nx">lastTime</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">);</span>
        <span class="nx">addEntry</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">timelog</span><span class="p">.</span><span class="nx">changes</span><span class="p">[</span><span class="nx">elem</span><span class="p">.</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="nx">timelog</span><span class="p">.</span><span class="nx">changes</span><span class="p">[</span><span class="nx">elem</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">eventArr</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1000</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">timelog</span><span class="p">.</span><span class="nx">changes</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sync</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">save</span><span class="p">();</span>
    <span class="nx">renderUI</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/** Synchronisation with server */</span>
<span class="kd">function</span> <span class="nx">sync</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">timelog</span><span class="p">.</span><span class="nx">changes</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">elem</span> <span class="o">=</span> <span class="nx">timelog</span><span class="p">.</span><span class="nx">changes</span><span class="p">[</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">timelog</span><span class="p">.</span><span class="nx">changes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]];</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>HACK: hardcoded url, as it only has one webservice-server</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;https://rasmuserik-timelog.appspot.com/?&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;name=&#39;</span> <span class="o">+</span> <span class="nx">timelog</span><span class="p">.</span><span class="nx">account</span> <span class="o">+</span>
        <span class="s1">&#39;&amp;since=&#39;</span> <span class="o">+</span> <span class="nx">timelog</span><span class="p">.</span><span class="nx">lastTime</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">+=</span> <span class="s1">&#39;&amp;id=&#39;</span> <span class="o">+</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;&amp;value=&#39;</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">url</span> <span class="o">+=</span><span class="s1">&#39;&amp;callback=?&#39;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="nx">syncCallback</span><span class="p">});</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="nx">sync</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h1>Main</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/** main function */</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;scrollable&#39;</span><span class="p">,</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">load</span><span class="p">();</span>
        <span class="nx">sync</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">getTaskList</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">getCurrent</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">usage</span><span class="p">());</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">update</span><span class="o">:</span> <span class="nx">renderUI</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 